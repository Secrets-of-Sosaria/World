using System;
using Server;
using System.Collections;

namespace Server.Items
{
	public class InvulnerabilityPotion : BasePotion
	{
		public override string DefaultDescription{ get{ return "These potions will make you invulnerable to all forms of harm, for a duration of one minute. There are many things you will not be able to do while in this state, but you will be able to do enough to avoid nearby dangers."; } }

		public override int Hue{ get { return ( Server.Items.PotionKeg.GetPotionColor( this ) ); } }

		[Constructable]
		public InvulnerabilityPotion() : base( 0x180F, PotionEffect.Invulnerability )
		{
			Name = "invulnerability potion";
			Weight = 1.0;
			Stackable = true;
		}

		public InvulnerabilityPotion( Serial serial ) : base( serial )
		{
		}

		public override void Serialize( GenericWriter writer )
		{
			base.Serialize( writer );

			writer.Write( (int) 0 ); // version
		}

		public override void Deserialize( GenericReader reader )
		{
			base.Deserialize( reader );

			int version = reader.ReadInt();

			ItemID = 0x180F;
			Hue = Server.Items.PotionKeg.GetPotionColor( this );
		}

		public override void Drink( Mobile m )
		{
			TimeSpan duration = TimeSpan.FromMinutes( 1 );
			
			if ( !m.Blessed )
			{
				m.FixedEffect( 0x375A, 10, 15 );
				m.PlaySound( 492 );
				
				BasePotion.PlayDrinkEffect( m );

				this.Consume();
				
				m.Blessed = true;
				m.NameHue = 0x35;
				
				RemoveTimer( m );
				
				Timer t = new InternalTimer( m, duration );

				m_Table[m] = t;

				BuffInfo.RemoveBuff( m, BuffIcon.PotionInvulnerable );
				BuffInfo.AddBuff( m, new BuffInfo( BuffIcon.PotionInvulnerable, 1063599, duration, m ));

				t.Start();
			}
			else
			{
				m.SendMessage( "An invulnerability potion is already taking effect on your person." ); //An invisibility potion is already taking effect on your person.
			}
		}
		
		private static Hashtable m_Table = new Hashtable();
		
		public static bool HasTimer( Mobile m )
		{
			return m_Table[m] != null;
		}

		public static void RemoveTimer( Mobile m )
		{
			Timer t = (Timer)m_Table[m];

			if ( t != null )
			{
				t.Stop();
				m_Table.Remove( m );
			}
		}

		private class InternalTimer : Timer
		{
			private Mobile m_Mobile;

			public InternalTimer( Mobile m, TimeSpan duration ) : base( duration )
			{
				Priority = TimerPriority.OneSecond;
				m_Mobile = m;
			}

			protected override void OnTick()
			{
				BuffInfo.RemoveBuff( m_Mobile, BuffIcon.PotionInvulnerable );
				m_Mobile.Blessed = false;
				m_Mobile.NameHue = -1;
				RemoveTimer( m_Mobile );
				m_Mobile.SendMessage( "The potion loses its effect, and you are once again mortal." );
			}
		}
	}
}